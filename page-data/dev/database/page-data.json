{"componentChunkName":"component---src-templates-documentation-page-js","path":"/dev/database/","result":{"data":{"markdownRemark":{"html":"<p>Crossfeed uses a relational database that uses Postgres. When running Crossfeed locally, the database is served from the container <code class=\"language-text\">crossfeed_db_1</code>. We rarely issue direct SQL queries to the database, but instead\nuse <a href=\"https://typeorm.io/#/\">TypeORM</a> to communicate with it.</p>\n<h3 id=\"directory-structure\" style=\"position:relative;\"><a href=\"#directory-structure\" aria-label=\"directory structure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Directory structure</h3>\n<p>The <code class=\"language-text\">backend/src/models</code> folder contains all the TypeORM models.</p>\n<p>The database is deployed onto AWS RDS. Configuration for this deployment is located in <code class=\"language-text\">infrastructure/database.tf</code>.</p>\n<h3 id=\"models\" style=\"position:relative;\"><a href=\"#models\" aria-label=\"models permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Models</h3>\n<p>Here is a list of database models used by Crossfeed:</p>\n<table>\n<thead>\n<tr>\n<th>Model Name</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Domain</td>\n<td>A Domain stores a record for each domain / subdomain found by Crossfeed.</td>\n</tr>\n<tr>\n<td>Service</td>\n<td>A Service runs on a given port on a domain, for example, \"http\" or \"ftp\".</td>\n</tr>\n<tr>\n<td>Vulnerability</td>\n<td>A Vulnerability is an indicator of a vulnerability, unique to a domain, such as a CVE.</td>\n</tr>\n<tr>\n<td>Webpage</td>\n<td>A Webpage is a web path that has been scraped on a Domain.</td>\n</tr>\n<tr>\n<td>ApiKey</td>\n<td>An ApiKey can be generated by users to programmatically access the Crossfeed API.</td>\n</tr>\n<tr>\n<td>Organization</td>\n<td>An Organization represents an entity to be scanned that has a defined scope of root domains.</td>\n</tr>\n<tr>\n<td>OrganizationTag</td>\n<td>An OrganizationTag can be used to group multiple organizations.</td>\n</tr>\n<tr>\n<td>Role</td>\n<td>A Role represents a User's access level to an Organization.</td>\n</tr>\n<tr>\n<td>User</td>\n<td>A User is an account that can access Crossfeed.</td>\n</tr>\n<tr>\n<td>SavedSearch</td>\n<td>A SavedSearch is a search that a User has saved.</td>\n</tr>\n<tr>\n<td>Scan</td>\n<td>A Scan is a scheduled data collection job.</td>\n</tr>\n<tr>\n<td>ScanTask</td>\n<td>A ScanTask represents a specific run, at a certain time and date, of a Scan.</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"entity-relationship-diagram-of-the-database\" style=\"position:relative;\"><a href=\"#entity-relationship-diagram-of-the-database\" aria-label=\"entity relationship diagram of the database permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Entity-relationship Diagram of the Database</h3>\n\n  <a class=\"gatsby-resp-image-link\" href=\"/static/92529237256ad3920468319edfbfa2ce/966c1/entity-relationship%20diagram.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n  \n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 88.51351351351352%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAACDElEQVQ4y41TaW/bMAz1//9zwz60WZI2p29LtnVTFz3GWYsFa4oRhiBLfDzeo4rlH8N1lRD2fZcxL8+twCdg4eK+HDLid+BnmW1MB8YkuM+TL8DSaetBOeO8e8gMcV912odv6i5OHeMO3tpee0//CXNaS9UhVR0LCYV3yltcY9L6NwvFpMFG5MrFfLs/DHw0+pbZp+2lqUe1b4fZEpgayeeRy48C/xB2J4VCEnxz6dtRunxzJcJnn471YB2Qy+TisexCyg+EQcJd0wxTz41+Z2LU5t5zJSbI+OvcDIwHXEoVNodSrrf4CU64MG1nCyrgdRy35dXE3CrYnuuQcTTANFAXE6RRO4jpDqb+H6Sitnf92ElJ+9H617LnLsqIOqJLGDN+rXPMmRtpQjj142wsuZFEs88zRDpUPsiQhHMh+BADIpoQBzkVAmzKUULcVR2kfGwGoYyK+SpmGeClYfu6JC6oox+ny7Epq3manD9P9r1lxbYiAqOC2HLhcfl5aidprgKO7aBCjOlWqs9IzUekze2Lq+iUv6i5oKkQkF7fTrPSNi3EVqOg6Zj15LYcGS+HVoKnOPg46kXDqIowQ9pcutkQ4QFSqoXr+eRXhjgJoUz66oUU1TBCiHfhSY/NtSZaWu0PVTsZt3xrxaHqiMF7WBNSzSYaIZpVroncT0mfgFthw0dNcp1n8GH5P/sNXuUXEy2wjEwAAAAASUVORK5CYII='); background-size: cover; display: block;\">\n      <img class=\"gatsby-resp-image-image\" style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\" alt=\"Entity-relationship Diagram of the relational database\" title=\"\" src=\"/static/92529237256ad3920468319edfbfa2ce/fcda8/entity-relationship%20diagram.png\" srcset=\"/static/92529237256ad3920468319edfbfa2ce/12f09/entity-relationship%20diagram.png 148w,\n/static/92529237256ad3920468319edfbfa2ce/e4a3f/entity-relationship%20diagram.png 295w,\n/static/92529237256ad3920468319edfbfa2ce/fcda8/entity-relationship%20diagram.png 590w,\n/static/92529237256ad3920468319edfbfa2ce/efc66/entity-relationship%20diagram.png 885w,\n/static/92529237256ad3920468319edfbfa2ce/c83ae/entity-relationship%20diagram.png 1180w,\n/static/92529237256ad3920468319edfbfa2ce/966c1/entity-relationship%20diagram.png 1694w\" sizes=\"(max-width: 590px) 100vw, 590px\">\n    </span>\n  </span>\n  \n  </a>\n    \n<h3 id=\"syncing-the-database\" style=\"position:relative;\"><a href=\"#syncing-the-database\" aria-label=\"syncing the database permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Syncing the database</h3>\n<p>You should sync the database using the <code class=\"language-text\">syncdb</code> command whenever models change and\nyou want to update the database schemas.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> backend\n<span class=\"token comment\"># Generate schema</span>\n<span class=\"token function\">npm</span> run syncdb\n<span class=\"token comment\"># Populate sample data</span>\n<span class=\"token function\">npm</span> run syncdb -- -d populate</code></pre></div>\n<h3 id=\"manual-access\" style=\"position:relative;\"><a href=\"#manual-access\" aria-label=\"manual access permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Manual access</h3>\n<p>To manually access the database, we use AWS Session Manager. This way, we don't need to run an EC2 bastion instance that's exposed to the public Internet.</p>\n<ul>\n<li>Install the <a href=\"https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html\">Session Manager plugin</a> to the AWS CLI on your development machine.</li>\n<li>\n<p>Set up a Session Manager port forwarding session to allow SSH access to the instance.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Set this environment variable to the ID of the EC2 bastion instance (which should be in a private subnet, but able to connect to the RDS instance).</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">INSTANCE_ID</span><span class=\"token operator\">=</span>\n<span class=\"token comment\"># Generate an SSH key and send it to the EC2 instance</span>\n<span class=\"token comment\"># (this only needs to be done once).</span>\nssh-keygen -f cisa_bastion_rsa\naws ec2-instance-connect send-ssh-public-key <span class=\"token punctuation\">\\</span>\n  --instance-id <span class=\"token variable\">$INSTANCE_ID</span> <span class=\"token punctuation\">\\</span>\n  --availability-zone us-east-1b <span class=\"token punctuation\">\\</span>\n  --instance-os-user ec2-user <span class=\"token punctuation\">\\</span>\n  --ssh-public-key file://cisa_bastion_rsa.pub\n\n<span class=\"token comment\"># Start port forwarding.</span>\naws ssm start-session <span class=\"token punctuation\">\\</span>\n  --target <span class=\"token variable\">$INSTANCE_ID</span> <span class=\"token punctuation\">\\</span>\n  --document-name AWS-StartPortForwardingSession <span class=\"token punctuation\">\\</span>\n  --parameters <span class=\"token string\">'{\"portNumber\":[\"22\"], \"localPortNumber\":[\"9999\"]}'</span></code></pre></div>\n</li>\n<li>\n<p>In another terminal, forward the RDS connection to your local computer using the SSH connection from earlier:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Set this environment variable to the URL of the RDS instance (XXX.rds.amazonaws.com)</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">RDS_URL</span><span class=\"token operator\">=</span>\n\n<span class=\"token comment\"># Forward RDS instance to localhost:5432</span>\n<span class=\"token function\">ssh</span> ec2-user@localhost <span class=\"token punctuation\">\\</span>\n  -p <span class=\"token number\">9999</span> <span class=\"token punctuation\">\\</span>\n  -N <span class=\"token punctuation\">\\</span>\n  -i cisa_bastion_rsa <span class=\"token punctuation\">\\</span>\n  -L <span class=\"token number\">5432</span>:<span class=\"token variable\">$RDS_URL</span>:5432</code></pre></div>\n</li>\n<li>You should now be able to connect to the database directly from your local computer (with the actual RDS database credentials), at the URL <code class=\"language-text\">localhost:5432</code>. You can use a tool such as <a href=\"https://dbeaver.io/\">DBeaver</a> to more easily handle / manage connections.</li>\n</ul>\n<p>These steps for manual access are based on <a href=\"https://checkmysite.io/blog/using-aws-systems-manager-and-ssh-to-access-an-rds-instance\">Connect to a private RDS instance using SSH &#x26; AWS SSM (Systems Manager)</a>.</p>","frontmatter":{"title":"Database","sidenav":"dev"},"fields":{"slug":"/dev/database/"},"headings":[{"value":"Directory structure","depth":3},{"value":"Models","depth":3},{"value":"Entity-relationship Diagram of the Database","depth":3},{"value":"Syncing the database","depth":3},{"value":"Manual access","depth":3}]}},"pageContext":{"name":"/dev/database/"}},"staticQueryHashes":["1824138477","3841949133","63159454"]}